<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now Playing - Nila</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Space Mono', monospace;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        /* Drag region */
        .drag-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 32px;
            -webkit-app-region: drag;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            z-index: 100;
        }

        .drag-bar .label {
            font-size: 11px;
            color: #eb5e28;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .close-btn {
            -webkit-app-region: no-drag;
            background: none;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #333;
            color: #fff;
        }

        /* Circular Album Art */
        .album-container {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 32px;
        }

        .album-art {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background-color: #1a1a1a;
            background-size: cover;
            background-position: center;
            box-shadow:
                0 0 0 4px #1a1a1a,
                0 0 0 6px #eb5e28,
                0 8px 32px rgba(235, 94, 40, 0.3);
            animation: spin 8s linear infinite;
            animation-play-state: paused;
        }

        .album-art.playing {
            animation-play-state: running;
        }

        /* Vinyl center hole */
        .album-art::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #0a0a0a;
            border-radius: 50%;
            border: 2px solid #333;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Song Info */
        .song-info {
            text-align: center;
            margin-bottom: 28px;
            width: 90%;
        }

        .song-title {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }

        .song-artist {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Progress bar */
        .progress-container {
            width: 80%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
        }

        .time-label {
            font-size: 11px;
            color: #666;
            min-width: 36px;
        }

        .progress-track {
            flex: 1;
            height: 3px;
            background: #333;
            border-radius: 2px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #eb5e28;
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s linear;
        }

        /* Controls */
        .controls {
            display: flex;
            align-items: center;
            gap: 28px;
        }

        .ctrl-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            transition: color 0.2s, transform 0.1s;
        }

        .ctrl-btn:hover {
            color: #fff;
        }

        .ctrl-btn:active {
            transform: scale(0.9);
        }

        .ctrl-btn svg {
            width: 28px;
            height: 28px;
            fill: currentColor;
        }

        .ctrl-btn.play-pause {
            background: #eb5e28;
            color: #fff;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(235, 94, 40, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ctrl-btn.play-pause:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px rgba(235, 94, 40, 0.5);
        }

        .ctrl-btn.play-pause svg {
            width: 24px;
            height: 24px;
        }

        /* Bottom accent line */
        .bottom-accent {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #eb5e28, transparent);
        }
    </style>
</head>

<body>
    <!-- Drag Bar -->
    <div class="drag-bar">
        <span class="label">NILA</span>
        <button class="close-btn" onclick="closeWindow()">âœ•</button>
    </div>

    <!-- Circular Album Art -->
    <div class="album-container">
        <div class="album-art" id="albumArt"></div>
    </div>

    <!-- Song Info -->
    <div class="song-info">
        <div class="song-title" id="floatTitle">No song selected</div>
        <div class="song-artist" id="floatArtist">---</div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <span class="time-label" id="floatTimeCurrent">00:00</span>
        <div class="progress-track">
            <div class="progress-fill" id="floatProgressFill"></div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button class="ctrl-btn" onclick="prevSong()">
            <svg viewBox="0 0 24 24">
                <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
            </svg>
        </button>
        <button class="ctrl-btn play-pause" id="floatPlayPauseBtn" onclick="togglePause()">
            <svg id="floatIconPlay" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" />
            </svg>
            <svg id="floatIconPause" style="display:none" viewBox="0 0 24 24">
                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
        </button>
        <button class="ctrl-btn" onclick="nextSong()">
            <svg viewBox="0 0 24 24">
                <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
            </svg>
        </button>
    </div>

    <div class="bottom-accent"></div>

    <script>
        const { ipcRenderer } = require("electron");

        let currentSong = null;
        let playing = false;
        let timerInterval = null;
        let seconds = 0;

        // Listen for song updates
        ipcRenderer.on("update-song", (event, song) => {
            currentSong = song;
            document.getElementById("floatTitle").textContent = song.title || "Unknown";
            document.getElementById("floatArtist").textContent = song.artist || "---";
            document.getElementById("albumArt").style.backgroundImage = `url('${song.thumbnail}')`;
            seconds = 0;
            updateProgress();
        });

        // Listen for play state
        ipcRenderer.on("update-play-state", (event, isPlaying) => {
            playing = isPlaying;
            updatePlayBtn();

            const art = document.getElementById("albumArt");
            if (playing) {
                art.classList.add("playing");
                startTimer();
            } else {
                art.classList.remove("playing");
                stopTimer();
            }
        });

        ipcRenderer.on("song-finished", () => {
            playing = false;
            updatePlayBtn();
            document.getElementById("albumArt").classList.remove("playing");
            stopTimer();
        });

        function updatePlayBtn() {
            document.getElementById("floatIconPlay").style.display = playing ? "none" : "block";
            document.getElementById("floatIconPause").style.display = playing ? "block" : "none";
        }

        function togglePause() {
            ipcRenderer.send("toggle-pause");
        }

        function prevSong() {
            ipcRenderer.send("play-prev");
        }

        function nextSong() {
            ipcRenderer.send("play-next");
        }

        function closeWindow() {
            ipcRenderer.send("close-floating-player");
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                seconds++;
                updateProgress();
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
        }

        function updateProgress() {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById("floatTimeCurrent").textContent =
                `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;

            if (currentSong && currentSong.duration) {
                const total = typeof currentSong.duration === "number" ? currentSong.duration : 180;
                const pct = (seconds / total) * 100;
                document.getElementById("floatProgressFill").style.width = `${Math.min(pct, 100)}%`;
            }
        }
    </script>
</body>

</html>